{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/extensions/file/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Kademlia } from \"../..\";\nimport bson from \"bson\";\nimport sha1 from \"sha1\";\nimport JobSystem from \"../../kademlia/services/jobsystem\";\n\nexport async function storeFile(file: ArrayBuffer[], kad: Kademlia) {\n  if (file.length > 0) {\n    const jobs: {\n      key: string;\n      value: Buffer;\n    }[] = [];\n\n    {\n      const last: ArrayBuffer = file.pop()!;\n      console.log({ last });\n      const item = { value: Buffer.from(last), next: undefined };\n      console.log({ item });\n      const value = bson.serialize(item);\n      const key = sha1(value).toString();\n      jobs.push({ key, value });\n    }\n    console.log({ file });\n\n    const reverse = file.reverse();\n    reverse.forEach(ab => {\n      const pre = jobs.slice(-1)[0];\n      const item = { value: Buffer.from(ab), next: pre.key };\n      const value = bson.serialize(item);\n      const key = sha1(value).toString();\n      jobs.push({ key, value });\n    });\n\n    const workers = new JobSystem({ a: 10 });\n\n    await Promise.all(\n      jobs.map(async job => {\n        await workers.add(kad.store.bind(kad), [job.key, job.value]);\n      })\n    );\n\n    return jobs.slice(-1)[0].key;\n  }\n  return undefined;\n}\n\nexport async function findFile(headerKey: string, kad: Kademlia) {\n  const chunks: Buffer[] = [];\n  const firstItem = await kad.findValue(headerKey);\n  if (!firstItem) return;\n  const firstJson: { value: Buffer; next: string } = bson.deserialize(\n    (firstItem.value as any).buffer\n  );\n  console.log({ firstJson });\n\n  const work = () =>\n    new Promise<boolean>(async (resolve, reject) => {\n      try {\n        for (let json = firstJson; ; ) {\n          chunks.push(json.value);\n          if (!json.next) {\n            resolve(true);\n            break;\n          }\n          const value = await kad.findValue(json.next);\n          if (!value) {\n            reject(false);\n            break;\n          }\n          json = bson.deserialize((value.value as any).buffer);\n          console.log({ json });\n        }\n      } catch (error) {}\n    });\n\n  if (firstItem) {\n    const res = await work().catch(console.error);\n    if (res) {\n      return chunks.map(buffer => buffer.buffer);\n    }\n  }\n  return undefined;\n}\n"]}