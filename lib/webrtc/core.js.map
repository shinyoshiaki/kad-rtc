{"version":3,"file":"core.js","sourceRoot":"","sources":["../../src/webrtc/core.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  RTCPeerConnection,\n  RTCSessionDescription,\n  RTCIceCandidate\n} from \"wrtc\";\n\nimport { Pack } from \"rx.mini\";\nimport SetupServices from \"./services\";\n\nexport interface message {\n  label: string | \"datachannel\";\n  data: any;\n  nodeId: string;\n}\n\ninterface option {\n  disable_stun: boolean;\n  stream: MediaStream;\n  track: MediaStreamTrack;\n  nodeId: string;\n  trickle: boolean;\n}\n\nexport default class WebRTC {\n  rtc: RTCPeerConnection;\n\n  private pack = Pack();\n  private event = this.pack.event;\n\n  onSignal = this.event<any>();\n  onConnect = this.event();\n  onDisconnect = this.event();\n  onData = this.event<message>();\n  onAddTrack = this.event<MediaStream>();\n\n  private dataChannels: { [key: string]: RTCDataChannel };\n\n  nodeId: string;\n  isConnected = false;\n  isDisconnected = false;\n  isOffer = false;\n\n  remoteStream: MediaStream | undefined;\n  timeoutPing: any | undefined;\n\n  services = SetupServices();\n\n  constructor(public opt: Partial<option> = {}) {\n    const { nodeId, stream, track } = opt;\n    const { arrayBufferService } = this.services;\n\n    this.dataChannels = {};\n    this.nodeId = nodeId || \"peer\";\n\n    this.rtc = this.prepareNewConnection();\n\n    if (stream) {\n      stream.getTracks().forEach(track => this.rtc.addTrack(track, stream));\n    } else if (track) {\n      this.rtc.addTrack(track);\n    }\n\n    arrayBufferService.listen(this);\n  }\n\n  private prepareNewConnection() {\n    const { disable_stun, trickle } = this.opt;\n\n    const peer: RTCPeerConnection = disable_stun\n      ? new RTCPeerConnection({\n          iceServers: []\n        })\n      : new RTCPeerConnection({\n          iceServers: [\n            {\n              urls: \"stun:stun.l.google.com:19302\"\n            }\n          ]\n        });\n\n    peer.ontrack = evt => {\n      const stream = evt.streams[0];\n      this.onAddTrack.execute(stream);\n      this.remoteStream = stream;\n    };\n\n    peer.oniceconnectionstatechange = () => {\n      switch (peer.iceConnectionState) {\n        case \"failed\":\n          break;\n        case \"disconnected\":\n          if (this.rtc)\n            try {\n              this.timeoutPing = setTimeout(() => {\n                this.hangUp();\n              }, 2000);\n\n              this.send(\"ping\", \"live\");\n            } catch (error) {\n              console.warn(\"disconnected\", { error });\n            }\n          break;\n        case \"connected\":\n          if (this.timeoutPing) clearTimeout(this.timeoutPing);\n          break;\n        case \"closed\":\n          break;\n        case \"completed\":\n          break;\n      }\n    };\n\n    peer.onicecandidate = evt => {\n      if (!this.isConnected) {\n        if (evt.candidate) {\n          if (trickle) {\n            this.onSignal.execute({ type: \"candidate\", ice: evt.candidate });\n          }\n        } else {\n          if (!trickle && peer.localDescription) {\n            this.onSignal.execute(peer.localDescription);\n          }\n        }\n      }\n    };\n\n    peer.ondatachannel = evt => {\n      const dataChannel = evt.channel;\n      this.dataChannels[dataChannel.label] = dataChannel;\n      this.dataChannelEvents(dataChannel);\n    };\n\n    peer.onsignalingstatechange = e => {\n      this.negotiating = peer.signalingState != \"stable\";\n    };\n\n    return peer;\n  }\n\n  hangUp() {\n    this.isDisconnected = true;\n    this.isConnected = false;\n    this.onDisconnect.execute();\n    this.disconnect();\n  }\n\n  makeOffer() {\n    this.isOffer = true;\n    const { trickle } = this.opt;\n    this.createDatachannel(\"datachannel\");\n\n    this.rtc.onnegotiationneeded = async () => {\n      if (this.negotiating || this.rtc.signalingState != \"stable\") return;\n      this.negotiating = true;\n\n      const sdp = await this.rtc.createOffer().catch(console.warn);\n\n      if (!sdp) return;\n\n      const result = await this.rtc.setLocalDescription(sdp).catch(() => \"err\");\n      if (result) return;\n\n      const local = this.rtc.localDescription;\n\n      if (trickle && local) {\n        this.onSignal.execute(local);\n      }\n\n      this.negotiationSetting();\n    };\n  }\n\n  negotiating = false;\n  private negotiationSetting() {\n    this.rtc.onnegotiationneeded = async () => {\n      if (!this.isConnected) return;\n      if (this.negotiating || this.rtc.signalingState != \"stable\") return;\n\n      this.negotiating = true;\n\n      const offer = await this.rtc.createOffer({}).catch(console.warn);\n      if (!offer) return;\n\n      const err = await this.rtc.setLocalDescription(offer).catch(() => \"err\");\n      if (err) return;\n\n      const local = this.rtc.localDescription;\n      if (local) this.send(JSON.stringify(local), \"update\");\n\n      this.negotiating = false;\n    };\n  }\n\n  private async setAnswer(sdp: any) {\n    await this.rtc\n      .setRemoteDescription(new RTCSessionDescription(sdp))\n      .catch(console.warn);\n  }\n\n  private async makeAnswer(offer: any) {\n    const { trickle } = this.opt;\n\n    const err = await this.rtc\n      .setRemoteDescription(new RTCSessionDescription(offer))\n      .catch(() => \"err\");\n    if (err) return;\n\n    const answer = await this.rtc.createAnswer().catch(console.warn);\n    if (!answer) return;\n\n    await this.rtc.setLocalDescription(answer).catch(console.warn);\n\n    const local = this.rtc.localDescription;\n    if (!local) return;\n\n    if (this.isConnected) this.send(JSON.stringify(local), \"update\");\n    else if (trickle) this.onSignal.execute(local);\n\n    this.negotiationSetting();\n  }\n\n  async setSdp(sdp: any) {\n    switch (sdp.type) {\n      case \"offer\":\n        this.makeAnswer(sdp);\n        break;\n      case \"answer\":\n        this.setAnswer(sdp);\n        break;\n      case \"candidate\":\n        await this.rtc\n          .addIceCandidate(new RTCIceCandidate(sdp.ice))\n          .catch(console.warn);\n        break;\n    }\n  }\n\n  private async createDatachannel(label: string) {\n    if (!Object.keys(this.dataChannels).includes(label)) {\n      try {\n        const dc = this.rtc.createDataChannel(label);\n        this.dataChannels[label] = dc;\n        await this.dataChannelEvents(dc);\n      } catch (dce) {\n        console.error(dce);\n      }\n    }\n  }\n\n  private dataChannelEvents(channel: RTCDataChannel) {\n    return new Promise(resolve => {\n      channel.onopen = () => {\n        if (!this.isConnected) {\n          this.isConnected = true;\n          this.onConnect.execute();\n        }\n        resolve();\n      };\n\n      channel.onmessage = async event => {\n        if (!event) return;\n        try {\n          if (channel.label === \"update\") {\n            const sdp = JSON.parse(event.data);\n            this.setSdp(sdp);\n          } else if (channel.label === \"live\") {\n            if (event.data === \"ping\") this.send(\"pong\", \"live\");\n            else if (this.timeoutPing) clearTimeout(this.timeoutPing);\n          } else {\n            this.onData.execute({\n              label: channel.label as string | \"datachannel\",\n              data: event.data,\n              nodeId: this.nodeId\n            });\n          }\n        } catch (error) {\n          console.warn(error);\n        }\n      };\n\n      channel.onerror = err => console.warn(err);\n      channel.onclose = () => {};\n    });\n  }\n\n  async send(data: string | ArrayBuffer | Buffer, label = \"datachannel\") {\n    const { arrayBufferService } = this.services;\n\n    if (!Object.keys(this.dataChannels).includes(label)) {\n      await this.createDatachannel(label);\n    }\n\n    const sendData = async () => {\n      if (typeof data === \"string\") {\n        this.dataChannels[label].send(data);\n      } else {\n        if (data.byteLength > 16000) {\n          await this.createDatachannel(arrayBufferService.label);\n          arrayBufferService.send(\n            data,\n            label,\n            this.dataChannels[arrayBufferService.label]\n          );\n        } else {\n          this.dataChannels[label].send(data);\n        }\n      }\n    };\n\n    try {\n      sendData();\n    } catch (error) {\n      console.warn(\"retry\", error);\n      await new Promise(r => r);\n      try {\n        sendData();\n      } catch (error) {\n        console.error(\"send fail\", error);\n      }\n    }\n  }\n\n  addTrack(track: MediaStreamTrack, stream: MediaStream) {\n    this.rtc.addTrack(track, stream);\n  }\n\n  private disconnect() {\n    const { rtc, dataChannels } = this;\n\n    if (!rtc) return;\n\n    for (let key in dataChannels) {\n      const channel = dataChannels[key];\n      channel.onmessage = null;\n      channel.onopen = null;\n      channel.onclose = null;\n      channel.onerror = null;\n      channel.close();\n    }\n    this.dataChannels = null as any;\n\n    rtc.oniceconnectionstatechange = null;\n    rtc.onicegatheringstatechange = null;\n    rtc.onsignalingstatechange = null;\n    rtc.onicecandidate = null;\n    rtc.ontrack = null;\n    rtc.ondatachannel = null;\n    rtc.close();\n    this.rtc = null as any;\n\n    this.pack.finishAll();\n  }\n}\n"]}