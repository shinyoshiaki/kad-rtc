{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/kademlia/actions/store/index.ts"],"names":[],"mappings":";;;AAEA,mEAAmC;AAEnC,SAA8B,KAAK,CACjC,EAAuB,EACvB,GAAW,EACX,KAA2B,EAC3B,GAAY;;QAEZ,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE,GAAG,EAAE,CAAC;QAC7C,MAAM,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC,GAAG,CAAC;QAC3B,MAAM,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC,OAAO,CAAC;QAE3B,GAAG,CAAC,GAAG,CAAC,GAAG,EAAE,KAAK,EAAE,GAAU,CAAC,CAAC;QAEhC,KACE,IAAI,OAAO,GAAG,EAAE,EAChB,OAAO,KAAK,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,EAC/B,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,EAC7B;YACA,MAAM,kBAAQ,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC;SACzB;QAED,MAAM,KAAK,GAAG,EAAE,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;QAEtC,MAAM,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC;QAEpC,MAAM,OAAO,GAAG,CAAO,IAAU,EAAE,EAAE;YACnC,MAAM,UAAU;iBACb,OAAO,CACN,IAAI,EACJ,IAAI,CACL,CAAC,OAAO,CAAC;iBACT,KAAK,CAAC,GAAG,EAAE,GAAE,CAAC,CAAC,CAAC;YACnB,sBAAsB;QACxB,CAAC,CAAA,CAAC;QAEF,MAAM,OAAO,CAAC,GAAG,CACf,KAAK,CAAC,GAAG,CAAC,CAAM,IAAI,EAAC,EAAE,wDAAC,OAAA,MAAM,SAAS,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,CAAC,CAAA,GAAA,CAAC,CAC9D,CAAC;QAEF,OAAO,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC;IACzB,CAAC;CAAA;AAvCD,wBAuCC;AAED,MAAM,KAAK,GAAG,CAAC,GAAW,EAAE,KAA2B,EAAE,GAAY,EAAE,EAAE,CAAC,CAAC;IACzE,IAAI,EAAE,OAAgB;IACtB,GAAG;IACH,KAAK;IACL,GAAG;CACJ,CAAC,CAAC","sourcesContent":["import { DependencyInjection } from \"../../di\";\nimport { Peer } from \"../../modules/peer/base\";\nimport findNode from \"../findnode\";\n\nexport default async function store(\n  di: DependencyInjection,\n  key: string,\n  value: string | ArrayBuffer,\n  msg?: string\n) {\n  const { kTable, rpcManager, jobSystem } = di;\n  const { timeout } = di.opt;\n  const { kvs } = di.modules;\n\n  kvs.set(key, value, msg as any);\n\n  for (\n    let preHash = \"\";\n    preHash !== kTable.getHash(key);\n    preHash = kTable.getHash(key)\n  ) {\n    await findNode(key, di);\n  }\n\n  const peers = di.kTable.findNode(key);\n\n  const item = Store(key, value, msg);\n\n  const onStore = async (peer: Peer) => {\n    await rpcManager\n      .getWait(\n        peer,\n        item\n      )(timeout)\n      .catch(() => {});\n    // TODO error handling\n  };\n\n  await Promise.all(\n    peers.map(async peer => await jobSystem.add(onStore, [peer]))\n  );\n\n  return { item, peers };\n}\n\nconst Store = (key: string, value: string | ArrayBuffer, msg?: string) => ({\n  type: \"Store\" as const,\n  key,\n  value,\n  msg\n});\n\nexport type Store = ReturnType<typeof Store>;\n"]}