{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/kademlia/actions/findnode/index.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  FindNodeProxyOffer,\n  Offer,\n  FindNodeProxyAnswerError\n} from \"./listen/proxy\";\nimport { DependencyInjection } from \"../../di\";\nimport { listeners } from \"../../listeners\";\nimport { Peer } from \"../../modules/peer/base\";\nimport { timeout } from \"../../const\";\n\nconst FindNode = (searchkid: string, except: string[]) => ({\n  rpc: \"FindNode\" as const,\n  searchkid,\n  except\n});\n\nexport type FindNode = ReturnType<typeof FindNode>;\n\nconst FindNodeAnswer = (sdp: string, peerkid: string) => ({\n  rpc: \"FindNodeAnswer\" as const,\n  sdp,\n  peerkid\n});\n\nexport type FindNodeAnswer = ReturnType<typeof FindNodeAnswer>;\n\nexport default async function findNode(\n  searchkid: string,\n  di: DependencyInjection\n) {\n  const { kTable, rpcManager, signaling } = di;\n\n  if (kTable.getPeer(searchkid)) return kTable.getPeer(searchkid);\n\n  const findNodeProxy = async (peer: Peer) => {\n    const except = kTable.allPeers.map(item => item.kid);\n\n    const wait = rpcManager.getWait<FindNodeProxyOffer>(\n      peer,\n      FindNode(searchkid, except)\n    );\n\n    const res = await wait(timeout).catch(() => {});\n\n    if (res) {\n      const { peers } = res;\n      if (peers.length > 0) return { peers, peer };\n    }\n    return { peers: [], peer };\n  };\n\n  const findNodeAnswer = async (proxy: Peer, offer: Offer) => {\n    const { peerkid, sdp } = offer;\n    const { peer, candidate } = signaling.create(peerkid);\n    if (peer) {\n      const answer = await peer.setOffer(JSON.parse(sdp));\n\n      rpcManager\n        .asObservable<FindNodeProxyAnswerError>(\n          \"FindNodeProxyAnswerError\",\n          proxy\n        )\n        .once(() => {\n          peer.onConnect.error(\"FindNodeProxyAnswerError\");\n        });\n\n      rpcManager.run(proxy, FindNodeAnswer(JSON.stringify(answer), peerkid));\n      const err = await peer.onConnect.asPromise(timeout).catch(() => \"err\");\n      if (err) {\n        signaling.delete(peerkid);\n      } else {\n        listeners(peer, di);\n      }\n    } else if (candidate) {\n      const peer = await candidate.asPromise(timeout).catch(() => {});\n      if (peer) listeners(peer, di);\n    }\n  };\n\n  const findNodeProxyOfferResult = await Promise.all(\n    kTable.findNode(searchkid).map(peer => findNodeProxy(peer))\n  );\n\n  await Promise.all(\n    findNodeProxyOfferResult\n      .map(item => item.peers.map(offer => findNodeAnswer(item.peer, offer)))\n      .flatMap(v => v)\n  );\n\n  return kTable.getPeer(searchkid);\n}\n"]}