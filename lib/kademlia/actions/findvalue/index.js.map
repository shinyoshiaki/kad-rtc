{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/kademlia/actions/findvalue/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { DependencyInjection } from \"../../di\";\nimport { FindValueResult, Offer } from \"./listen/proxy\";\nimport { listeners } from \"../../listeners\";\nimport Peer from \"../../modules/peer/base\";\nimport { timeout } from \"../../const\";\n\nconst FindValue = (key: string, except: string[]) => {\n  return { rpc: \"FindValue\" as const, key, except };\n};\n\nexport type FindValue = ReturnType<typeof FindValue>;\n\nconst FindValueAnswer = (sdp: any, peerkid: string) => {\n  return { rpc: \"FindValueAnswer\" as const, sdp, peerkid };\n};\n\nexport type FindValueAnswer = ReturnType<typeof FindValueAnswer>;\n\nexport default async function findValue(key: string, di: DependencyInjection) {\n  const { kTable, rpcManager, signaling } = di;\n\n  let result: string | ArrayBuffer | undefined | Buffer;\n\n  const findValueResult = async (peer: Peer) => {\n    const except = kTable.allPeers.map(item => item.kid);\n\n    const wait = rpcManager.getWait<FindValueResult>(\n      peer,\n      FindValue(key, except)\n    );\n    const res = await wait(timeout).catch(() => {});\n\n    if (res) {\n      const { value, offers } = res.data;\n\n      if (value) {\n        result = value;\n      } else if (offers) {\n        if (offers.length > 0) {\n          return { offers, peer };\n        }\n      }\n    }\n    return { offers: [], peer };\n  };\n\n  const findValueAnswer = async (offer: Offer, proxy: Peer) => {\n    const { peerkid, sdp } = offer;\n\n    const { peer, candidate } = signaling.create(peerkid);\n\n    if (peer) {\n      const answer = await peer.setOffer(sdp);\n\n      rpcManager.run(proxy, FindValueAnswer(answer, peerkid));\n      const res = await peer.onConnect.asPromise(timeout).catch(() => {\n        signaling.delete(peerkid);\n      });\n      if (res) {\n        listeners(peer, di);\n      }\n    } else if (candidate) {\n      const peer = await candidate.asPromise(timeout).catch(() => {});\n      if (peer) listeners(peer, di);\n    }\n  };\n\n  const job = async () => {\n    const findValueResultResult = await Promise.all(\n      kTable.allPeers.map(peer => findValueResult(peer))\n    );\n    await Promise.all(\n      findValueResultResult\n        .map(item =>\n          item.offers.map(offer => findValueAnswer(offer, item.peer))\n        )\n        .flatMap(v => v)\n    );\n  };\n\n  for (\n    let preHash = \"\";\n    preHash !== kTable.getHash(key);\n    preHash = kTable.getHash(key)\n  ) {\n    await job();\n    if (result) break;\n  }\n\n  return result;\n}\n"]}