{"version":3,"file":"peer.js","sourceRoot":"","sources":["../../../../../src/kademlia/actions/findvalue/listen/peer.ts"],"names":[],"mappings":";;;AAEA,kDAA+C;AAG/C,MAAM,kBAAkB,GAAG,CAAC,GAAQ,EAAE,OAAe,EAAE,EAAE;IACvD,OAAO,EAAE,GAAG,EAAE,oBAA6B,EAAE,GAAG,EAAE,OAAO,EAAE,CAAC;AAC9D,CAAC,CAAC;AAMF,MAAqB,aAAa;IAGhC,YAAoB,MAAY,EAAU,EAAuB;QAA7C,WAAM,GAAN,MAAM,CAAM;QAAU,OAAE,GAAF,EAAE,CAAqB;QAFjE,cAAS,GAA4B,EAAE,CAAC;QAGtC,MAAM,MAAM,GAAG,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,CAAO,IAAa,EAAE,EAAE;YAC5D,QAAQ,IAAI,CAAC,GAAG,EAAE;gBAChB,KAAK,oBAAoB;oBACvB,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC;oBAC9B,MAAM;gBACR,KAAK,sBAAsB;oBACzB,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAC;oBAChC,MAAM;aACT;QACH,CAAC,CAAA,CAAC,CAAC;QAEH,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC,CAAC;IACvD,CAAC;IAEK,kBAAkB,CAAC,IAAwB;;YAC/C,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC;YAC3B,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,EAAE,CAAC;YAEvC,MAAM,IAAI,GAAG,UAAU,CAAC,SAAS,CAAC,CAAC;YACnC,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,GAAG,IAAI,CAAC;YAEjC,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,WAAW,EAAE,CAAC;YAEvC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,kBAAkB,CAAC,KAAK,EAAE,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;QACzD,CAAC;KAAA;IAEK,oBAAoB,CAAC,IAA0B;;YACnD,MAAM,EAAE,SAAS,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;YAChC,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,EAAE,CAAC;YAE3B,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;YACvC,IAAI,CAAC,IAAI;gBAAE,OAAO;YAClB,MAAM,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;YAE1B,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACjB,qBAAS,CAAC,IAAI,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC;QAC3B,CAAC;KAAA;CACF;AAzCD,gCAyCC","sourcesContent":["import Peer from \"../../../modules/peer\";\nimport { DependencyInjection } from \"../../../di\";\nimport { listeners } from \"../../../listeners\";\nimport { FindValueProxyOpen, FindValueProxyAnswer } from \"./proxy\";\n\nconst FindValuePeerOffer = (sdp: any, peerkid: string) => {\n  return { rpc: \"FindValuePeerOffer\" as const, sdp, peerkid };\n};\n\nexport type FindValuePeerOffer = ReturnType<typeof FindValuePeerOffer>;\n\ntype actions = FindValueProxyOpen | FindValueProxyAnswer;\n\nexport default class FindValuePeer {\n  signaling: { [key: string]: Peer } = {};\n\n  constructor(private listen: Peer, private di: DependencyInjection) {\n    const discon = listen.onRpc.subscribe(async (data: actions) => {\n      switch (data.rpc) {\n        case \"FindValueProxyOpen\":\n          this.findValueProxyOpen(data);\n          break;\n        case \"FindValueProxyAnswer\":\n          this.findValueProxyAnswer(data);\n          break;\n      }\n    });\n\n    listen.onDisconnect.once(() => discon.unSubscribe());\n  }\n\n  async findValueProxyOpen(data: FindValueProxyOpen) {\n    const { finderkid } = data;\n    const { peerModule, kTable } = this.di;\n\n    const peer = peerModule(finderkid);\n    this.signaling[finderkid] = peer;\n\n    const offer = await peer.createOffer();\n\n    this.listen.rpc(FindValuePeerOffer(offer, kTable.kid));\n  }\n\n  async findValueProxyAnswer(data: FindValueProxyAnswer) {\n    const { finderkid, sdp } = data;\n    const { kTable } = this.di;\n\n    const peer = this.signaling[finderkid];\n    if (!peer) return;\n    await peer.setAnswer(sdp);\n\n    kTable.add(peer);\n    listeners(peer, this.di);\n  }\n}\n"]}