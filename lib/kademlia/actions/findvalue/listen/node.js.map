{"version":3,"file":"node.js","sourceRoot":"","sources":["../../../../../src/kademlia/actions/findvalue/listen/node.ts"],"names":[],"mappings":"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","sourcesContent":["import { FindValue, FindValueAnswer } from \"..\";\nimport { ID, Peer } from \"../../../modules/peer/base\";\n\nimport { DependencyInjection } from \"../../../di\";\nimport { FindValuePeerOffer } from \"./signaling\";\nimport { Item } from \"../../../modules/kvs/base\";\nimport { Signal } from \"webrtc4me\";\n\nexport default class FindValueProxy {\n  timeout = this.di.opt.timeout! / 2;\n\n  constructor(private listen: Peer, private di: DependencyInjection) {\n    const { rpcManager } = di;\n\n    rpcManager\n      .asObservable<FindValue>(\"FindValue\", listen)\n      .subscribe(this.findvalue);\n\n    rpcManager\n      .asObservable<FindValueAnswer>(\"FindValueAnswer\", listen)\n      .subscribe(this.findValueAnswer);\n  }\n\n  findvalue = async (data: FindValue & ID) => {\n    const { kTable, rpcManager } = this.di;\n    const { kvs } = this.di.modules;\n    const { key, except, id } = data;\n\n    const item = kvs.get(key);\n\n    if (item) {\n      this.listen.rpc({ ...FindValueResult({ item }), id });\n    } else {\n      const peers = kTable.findNode(key);\n      const offers: { peerKid: string; sdp: Signal }[] = [];\n\n      await Promise.all(\n        peers.map(async peer => {\n          if (!(peer.kid === this.listen.kid || except.includes(peer.kid))) {\n            const res = await rpcManager\n              .getWait<FindValuePeerOffer>(\n                peer,\n                FindValueProxyOpen(this.listen.kid)\n              )(this.timeout)\n              .catch(() => {});\n\n            if (res) {\n              const { peerKid, sdp } = res;\n              if (sdp) offers.push({ peerKid, sdp });\n            } else {\n              console.log(\"timeout\");\n            }\n          }\n        })\n      );\n\n      this.listen.rpc({ ...FindValueResult({ offers }), id });\n    }\n  };\n\n  findValueAnswer = (data: FindValueAnswer & ID) => {\n    const { kTable } = this.di;\n    const { sdp, peerKid, id } = data;\n\n    const peer = kTable.getPeer(peerKid);\n    if (!peer) return;\n    peer.rpc({ ...FindValueProxyAnswer(sdp, this.listen.kid), id });\n  };\n}\n\nconst FindValueResult = (\n  value: Partial<{ item: Item; offers: OfferPayload[] }>\n) => ({\n  type: \"FindValueResult\" as const,\n  value\n});\n\nexport type OfferPayload = { peerKid: string; sdp: Signal };\n\nexport type FindValueResult = ReturnType<typeof FindValueResult>;\n\nconst FindValueProxyOpen = (finderKid: string) => ({\n  type: \"FindValueProxyOpen\" as const,\n  finderKid\n});\n\nexport type FindValueProxyOpen = ReturnType<typeof FindValueProxyOpen>;\n\nconst FindValueProxyAnswer = (sdp: Signal, finderKid: string) => ({\n  type: \"FindValueProxyAnswer\" as const,\n  sdp,\n  finderKid\n});\n\nexport type FindValueProxyAnswer = ReturnType<typeof FindValueProxyAnswer>;\n"]}