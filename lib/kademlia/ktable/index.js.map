{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/kademlia/ktable/index.ts"],"names":[],"mappings":";;;AAAA,gEAAyD;AACzD,+CAAwC;AAExC,wDAAwB;AACxB,qCAA+B;AAI/B,MAAqB,MAAM;IAMzB,YAAmB,GAAW,EAAE,MAAuB,EAAE;QAAtC,QAAG,GAAH,GAAG,CAAQ;QALrB,aAAQ,GAAc,EAAE,CAAC;QAC1B,MAAC,GAAG,EAAE,CAAC;QACf,SAAI,GAAG,cAAI,EAAE,CAAC;QACd,UAAK,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,EAAQ,CAAC;QAkBhC,aAAQ,GAAG,CAAC,GAAW,EAAU,EAAE,CACjC,IAAI,CAAC,QAAQ;aACV,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,uBAAQ,CAAC,CAAC,CAAC,GAAG,EAAE,GAAG,CAAC,GAAG,uBAAQ,CAAC,CAAC,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;aAC3D,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC;QAgBtB,YAAO,GAAG,CAAC,GAAW,EAAoB,EAAE,CAC1C,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,GAAG,KAAK,GAAG,CAAC,CAAC;QAE/C,YAAO,GAAG,CAAC,GAAW,EAAE,EAAE,CACxB,cAAI,CACF,IAAI,CAAC,SAAS,CACZ,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC;aACf,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC;aACf,IAAI,EAAE,CACV,CACF,CAAC,QAAQ,EAAE,CAAC;QAEf,WAAM,GAAG,CAAC,GAAW,EAAE,EAAE;YACvB,MAAM,MAAM,GAAG,uBAAQ,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;YACvC,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;YACtC,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QACtB,CAAC,CAAC;QAlDA,MAAM,EAAE,CAAC,EAAE,GAAG,IAAI,CAAC;QACnB,MAAM,EAAE,WAAW,EAAE,GAAG,GAAG,CAAC;QAE5B,IAAI,CAAC,CAAC,GAAG,WAAW,IAAI,CAAC,CAAC;QAE1B,IAAI,CAAC,QAAQ,GAAG,CAAC,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,IAAI,iBAAO,CAAC,GAAG,CAAC,CAAC,CAAC;IAC9D,CAAC;IAED,GAAG,CAAC,IAAU;QACZ,MAAM,MAAM,GAAG,uBAAQ,CAAC,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC;QAC5C,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;QACtC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAClB,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;IAC3B,CAAC;IAOD,IAAI,QAAQ;QACV,OAAO,IAAI,CAAC,QAAQ;aACjB,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;aACxD,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC;IAC3B,CAAC;IAED,IAAI,OAAO;QACT,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;IACvC,CAAC;IAED,IAAI,WAAW;QACb,OAAO,IAAI,CAAC,CAAC,CAAC;IAChB,CAAC;CAmBF;AA1DD,yBA0DC","sourcesContent":["import Kbucket, { Option as OptBucket } from \"./kbucket\";\nimport { distance } from \"kad-distance\";\nimport Peer from \"../modules/peer/base\";\nimport sha1 from \"sha1\";\nimport { Pack } from \"rx.mini\";\n\nexport type Option = OptBucket;\n\nexport default class Ktable {\n  readonly kbuckets: Kbucket[] = [];\n  private k = 20;\n  pack = Pack();\n  onAdd = this.pack.event<Peer>();\n\n  constructor(public kid: string, opt: Partial<Option> = {}) {\n    const { k } = this;\n    const { kBucketSize } = opt;\n\n    this.k = kBucketSize || k;\n\n    this.kbuckets = [...Array(160)].map(() => new Kbucket(opt));\n  }\n\n  add(peer: Peer) {\n    const length = distance(this.kid, peer.kid);\n    const kbucket = this.kbuckets[length];\n    kbucket.add(peer);\n    this.onAdd.execute(peer);\n  }\n\n  findNode = (kid: string): Peer[] =>\n    this.allPeers\n      .sort((a, b) => distance(a.kid, kid) - distance(b.kid, kid))\n      .slice(0, this.k);\n\n  get allPeers() {\n    return this.kbuckets\n      .map(kbucket => kbucket.peers.map(bucket => bucket.peer))\n      .flatMap(item => item);\n  }\n\n  get allKids() {\n    return this.allPeers.map(v => v.kid);\n  }\n\n  get kBucketSize() {\n    return this.k;\n  }\n\n  getPeer = (kid: string): Peer | undefined =>\n    this.allPeers.find(peer => peer.kid === kid);\n\n  getHash = (kid: string) =>\n    sha1(\n      JSON.stringify(\n        this.findNode(kid)\n          .map(v => v.kid)\n          .sort()\n      )\n    ).toString();\n\n  rmPeer = (kid: string) => {\n    const length = distance(this.kid, kid);\n    const kbucket = this.kbuckets[length];\n    kbucket.rmPeer(kid);\n  };\n}\n"]}