{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/kademlia/services/jobsystem/index.ts"],"names":[],"mappings":";;;AAAA,8DAA4B;AAS5B,MAAM,MAAM;IAGV,YAAoB,IAAW;QAAX,SAAI,GAAJ,IAAI,CAAO;QAF/B,YAAO,GAAG,KAAK,CAAC;IAEkB,CAAC;IAErB,OAAO;;YACnB,MAAM,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC;YAC9B,IAAI,GAAG,EAAE;gBACP,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;gBAEpB,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,GAAG,CAAC;gBAElC,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,GAAG,IAAI,CAAC,CAAC;gBAChC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;gBAEnB,IAAI,CAAC,OAAO,EAAE,CAAC;aAChB;iBAAM;gBACL,IAAI,CAAC,OAAO,GAAG,KAAK,CAAC;aACtB;QACH,CAAC;KAAA;IAED,MAAM;QACJ,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE;YACjB,IAAI,CAAC,OAAO,EAAE,CAAC;SAChB;IACH,CAAC;CACF;AAED,MAAqB,SAAS;IAI5B,YAAoB,MAAc,EAAE,CAAC,EAAE,CAAC,EAAE;QAAtB,QAAG,GAAH,GAAG,CAAmB;QAH1C,SAAI,GAAU,EAAE,CAAC;QACjB,YAAO,GAAa,EAAE,CAAC;QAGrB,MAAM,EAAE,CAAC,EAAE,GAAG,GAAG,CAAC;QAClB,IAAI,CAAC,OAAO,GAAG,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,IAAI,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;IAChE,CAAC;IAEK,GAAG,CACP,IAAO,EACP,IAAqB;;YAErB,MAAM,EAAE,CAAC,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC;YAEvB,MAAM,KAAK,GAAG,IAAI,iBAAK,EAA0B,CAAC;YAElD,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC;YAEtC,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;gBACxB,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC,CAAC;aACjD;YAED,OAAO,KAAK,CAAC,SAAS,EAAE,CAAC;QAC3B,CAAC;KAAA;CACF;AAzBD,4BAyBC","sourcesContent":["import Event from \"rx.mini\";\n\ntype Option = { a: number };\n\ntype AA<T> = T extends (...arg: infer I) => any ? I : never;\ntype ThenArg<T> = T extends Promise<infer U> ? U : T;\n\ntype Job = { func: any; args: any[]; event: Event<any> };\n\nclass Worker {\n  running = false;\n\n  constructor(private jobs: Job[]) {}\n\n  private async execute() {\n    const job = this.jobs.shift();\n    if (job) {\n      this.running = true;\n\n      const { func, args, event } = job;\n\n      const res = await func(...args);\n      event.execute(res);\n\n      this.execute();\n    } else {\n      this.running = false;\n    }\n  }\n\n  wakeup() {\n    if (!this.running) {\n      this.execute();\n    }\n  }\n}\n\nexport default class JobSystem {\n  jobs: Job[] = [];\n  workers: Worker[] = [];\n\n  constructor(private opt: Option = { a: 5 }) {\n    const { a } = opt;\n    this.workers = [...Array(a)].map(() => new Worker(this.jobs));\n  }\n\n  async add<T extends (...args: any[]) => Promise<any>>(\n    func: T,\n    args: AA<typeof func>\n  ) {\n    const { a } = this.opt;\n\n    const event = new Event<ThenArg<ReturnType<T>>>();\n\n    this.jobs.push({ func, args, event });\n\n    if (this.jobs.length < a) {\n      this.workers.forEach(worker => worker.wakeup());\n    }\n\n    return event.asPromise();\n  }\n}\n"]}