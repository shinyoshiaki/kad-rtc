{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/kademlia/services/eventmanager/index.ts"],"names":[],"mappings":";;;AAEA,8DAA4B;AAQ5B,MAAqB,YAAY;IAO/B,YAAmB,UAAsB;QAAtB,eAAU,GAAV,UAAU,CAAY;QANzC,UAAK,GAAG,IAAI,iBAAK,EAAiB,CAAC;QACnC,UAAK,GAAG,IAAI,iBAAK,EAAwB,CAAC;QAC1C,aAAQ,GAAG,IAAI,iBAAK,EAA2B,CAAC;QAChD,cAAS,GAAG,IAAI,iBAAK,EAA4B,CAAC;QAClD,YAAO,GAAG,IAAI,iBAAK,EAAQ,CAAC;IAEgB,CAAC;IAE7C,MAAM,CAAC,IAAU;QACf,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QACvB,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;QAC1B,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;QAE3B;YACE,MAAM,EAAE,WAAW,EAAE,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE;gBACjD,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,GAAU,EAAE,IAAI,EAAE,CAAC,CAAC;YAChD,CAAC,CAAC,CAAC;YACH,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;SACrC;QAED,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;IAC7B,CAAC;IAEO,WAAW,CAAC,IAAU;QAC5B,IAAI,CAAC,UAAU;aACZ,YAAY,CAAQ,OAAO,EAAE,IAAI,CAAC;aAClC,SAAS,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,GAAiB,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC;IAC5E,CAAC;IAEO,cAAc,CAAC,IAAU;QAC/B,IAAI,CAAC,UAAU;aACZ,YAAY,CAAW,UAAU,EAAE,IAAI,CAAC;aACxC,SAAS,CAAC,GAAG,CAAC,EAAE,CACf,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,GAAoB,EAAE,IAAI,EAAE,CAAC,CAC3D,CAAC;IACN,CAAC;IAEO,eAAe,CAAC,IAAU;QAChC,IAAI,CAAC,UAAU;aACZ,YAAY,CAAY,WAAW,EAAE,IAAI,CAAC;aAC1C,SAAS,CAAC,GAAG,CAAC,EAAE,CACf,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,GAAqB,EAAE,IAAI,EAAE,CAAC,CAC7D,CAAC;IACN,CAAC;IAED,YAAY,CAAgB,OAAkB;QAC5C,MAAM,KAAK,GAAG,IAAI,iBAAK,EAAe,CAAC;QACvC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE,EAAE;YACrC,IAAI,OAAO,KAAK,GAAG,CAAC,IAAI,EAAE;gBACxB,KAAK,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,GAAQ,EAAE,IAAI,EAAE,CAAC,CAAC;aACxC;QACH,CAAC,CAAC,CAAC;QACH,OAAO,KAAK,CAAC;IACf,CAAC;CACF;AAvDD,+BAuDC","sourcesContent":["import { ID, Peer, RPC } from \"../../modules/peer/base\";\n\nimport Event from \"rx.mini\";\nimport { FindNode } from \"../../actions/findnode\";\nimport { FindValue } from \"../../actions/findvalue\";\nimport RpcManager from \"../rpcmanager\";\nimport { Store } from \"../../actions/store\";\n\ntype WithPeer<T> = { rpc: T; peer: Peer };\n\nexport default class EventManager {\n  event = new Event<WithPeer<RPC>>();\n  store = new Event<WithPeer<Store & ID>>();\n  findnode = new Event<WithPeer<FindNode & ID>>();\n  findvalue = new Event<WithPeer<FindValue & ID>>();\n  addPeer = new Event<Peer>();\n\n  constructor(public rpcManager: RpcManager) {}\n\n  listen(peer: Peer) {\n    this.listenStore(peer);\n    this.listenFindnode(peer);\n    this.listenFindvalue(peer);\n\n    {\n      const { unSubscribe } = peer.onRpc.subscribe(rpc => {\n        this.event.execute({ rpc: rpc as RPC, peer });\n      });\n      peer.onDisconnect.once(unSubscribe);\n    }\n\n    this.addPeer.execute(peer);\n  }\n\n  private listenStore(peer: Peer) {\n    this.rpcManager\n      .asObservable<Store>(\"Store\", peer)\n      .subscribe(rpc => this.store.execute({ rpc: rpc as Store & ID, peer }));\n  }\n\n  private listenFindnode(peer: Peer) {\n    this.rpcManager\n      .asObservable<FindNode>(\"FindNode\", peer)\n      .subscribe(rpc =>\n        this.findnode.execute({ rpc: rpc as FindNode & ID, peer })\n      );\n  }\n\n  private listenFindvalue(peer: Peer) {\n    this.rpcManager\n      .asObservable<FindValue>(\"FindValue\", peer)\n      .subscribe(rpc =>\n        this.findvalue.execute({ rpc: rpc as FindValue & ID, peer })\n      );\n  }\n\n  selectListen<T extends RPC>(rpcCode: T[\"type\"]) {\n    const event = new Event<WithPeer<T>>();\n    this.event.subscribe(({ rpc, peer }) => {\n      if (rpcCode === rpc.type) {\n        event.execute({ rpc: rpc as T, peer });\n      }\n    });\n    return event;\n  }\n}\n"]}