{"version":3,"file":"proxy.js","sourceRoot":"","sources":["../../../../../../../../src/kademlia/actions/findnode/listen/proxy.ts"],"names":[],"mappings":"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","sourcesContent":["import Peer from \"../../../modules/peer/base\";\nimport { FindNode, FindNodeAnswer } from \"..\";\nimport { FindNodePeerOffer } from \"./peer\";\nimport { DependencyInjection } from \"../../../di\";\n\nconst FindNodeProxyOffer = (peers: Offer[]) => {\n  return { rpc: \"FindNodeProxyOffer\" as const, peers };\n};\n\nexport type Offer = { peerkid: string; sdp: any };\n\nexport type FindNodeProxyOffer = ReturnType<typeof FindNodeProxyOffer>;\n\nconst FindNodeProxyOpen = (finderkid: string) => {\n  return { rpc: \"FindNodeProxyOpen\" as const, finderkid };\n};\n\nexport type FindNodeProxyOpen = ReturnType<typeof FindNodeProxyOpen>;\n\nconst FindNodeProxyAnswer = (sdp: any, finderkid: string) => {\n  return { rpc: \"FindNodeProxyAnswer\" as const, sdp, finderkid };\n};\n\nexport type FindNodeProxyAnswer = ReturnType<typeof FindNodeProxyAnswer>;\n\ntype actions = FindNode | FindNodeAnswer;\n\nexport default class FindNodeProxy {\n  constructor(private listen: Peer, private di: DependencyInjection) {\n    const discon = listen.onRpc.subscribe((data: actions) => {\n      switch (data.rpc) {\n        case \"FindNode\":\n          this.findnode(data);\n          break;\n        case \"FindNodeAnswer\":\n          this.findnodeanswer(data);\n          break;\n      }\n    });\n\n    listen.onDisconnect.once(() => discon.unSubscribe());\n  }\n\n  async findnode(data: FindNode) {\n    const { searchkid, except } = data;\n    const { kTable } = this.di;\n    const peers = kTable.findNode(searchkid);\n    const offers: { peerkid: string; sdp: any }[] = [];\n\n    const findNodePeerOffer = async (peer: Peer) => {\n      if (!(peer.kid === this.listen.kid || except.includes(peer.kid))) {\n        peer.rpc(FindNodeProxyOpen(this.listen.kid));\n\n        const res = await peer\n          .eventRpc<FindNodePeerOffer>(\"FindNodePeerOffer\")\n          .asPromise(3333)\n          .catch(console.warn);\n\n        if (res) {\n          const { peerkid, sdp } = res;\n          offers.push({ peerkid, sdp });\n        }\n      }\n    };\n\n    await Promise.all(peers.map(peer => findNodePeerOffer(peer)));\n\n    this.listen.rpc(FindNodeProxyOffer(offers));\n  }\n\n  async findnodeanswer(data: FindNodeAnswer) {\n    const { sdp, peerkid } = data;\n    const { kTable } = this.di;\n    const peer = kTable.getPeer(peerkid);\n    if (!peer) return;\n    peer.rpc(FindNodeProxyAnswer(sdp, this.listen.kid));\n  }\n}\n"]}